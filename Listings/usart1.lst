


ARM Macro Assembler    Page 1 


    1 00000000         ;=======================================================
                       ===
    2 00000000         ;  usart1.s
    3 00000000         ;  ÂäüËÉΩ: USART1 È©±Âä® (TX=PB6, RX=PB7) & printf ÈáçÂÆ
                       öÂêë
    4 00000000         ;=======================================================
                       ===
    5 00000000                 PRESERVE8
    6 00000000                 THUMB
    7 00000000         
    8 00000000         ;-------------------------- ÂØÑÂ≠òÂô®Âú∞ÂùÄÂÆö‰πâ ------
                       ---------------------
    9 00000000         ; RCC (Êó∂ÈíüÊéßÂà∂)
   10 00000000 40023800 
                       RCC_BASE
                               EQU              0x40023800
   11 00000000 40023830 
                       RCC_AHB1ENR
                               EQU              (RCC_BASE + 0x30)
   12 00000000 40023844 
                       RCC_APB2ENR
                               EQU              (RCC_BASE + 0x44)
   13 00000000         
   14 00000000         ; GPIOB (PB6, PB7)
   15 00000000 40020400 
                       GPIOB_BASE
                               EQU              0x40020400  ; Ê≥®ÊÑè: GPIOB Âü∫
                                                            Âú∞ÂùÄÊòØ 0x4002040
                                                            0
   16 00000000 40020400 
                       GPIOB_MODER
                               EQU              (GPIOB_BASE + 0x00)
   17 00000000 40020404 
                       GPIOB_OTYPER
                               EQU              (GPIOB_BASE + 0x04)
   18 00000000 40020408 
                       GPIOB_OSPEEDR
                               EQU              (GPIOB_BASE + 0x08)
   19 00000000 4002040C 
                       GPIOB_PUPDR
                               EQU              (GPIOB_BASE + 0x0C)
   20 00000000 40020420 
                       GPIOB_AFRL
                               EQU              (GPIOB_BASE + 0x20)
   21 00000000         
   22 00000000         ; USART1
   23 00000000 40011000 
                       USART1_BASE
                               EQU              0x40011000  ; USART1 Âú® APB2 Ê
                                                            ÄªÁ∫ø
   24 00000000 40011000 
                       USART1_SR
                               EQU              (USART1_BASE + 0x00)
   25 00000000 40011004 
                       USART1_DR
                               EQU              (USART1_BASE + 0x04)
   26 00000000 40011008 
                       USART1_BRR
                               EQU              (USART1_BASE + 0x08)



ARM Macro Assembler    Page 2 


   27 00000000 4001100C 
                       USART1_CR1
                               EQU              (USART1_BASE + 0x0C)
   28 00000000         
   29 00000000         ; ‰ΩçÊé©Á†ÅÂ∏∏Èáè
   30 00000000 00000002 
                       RCC_AHB1ENR_GPIOBEN
                               EQU              (1<<1)      ; Bit 1: GPIOB Êó∂È
                                                            íü
   31 00000000 00000010 
                       RCC_APB2ENR_USART1EN
                               EQU              (1<<4)      ; Bit 4: USART1 Êó∂
                                                            Èíü
   32 00000000 00000007 
                       GPIO_AF_USART1
                               EQU              0x07        ; USART1 ÂØπÂ∫îÁöÑÂ
                                                            §çÁî®ÂäüËÉΩÂè∑ÊòØ A
                                                            F7
   33 00000000 00002000 
                       USART_CR1_UE
                               EQU              (1<<13)     ; USART Enable
   34 00000000 00000008 
                       USART_CR1_TE
                               EQU              (1<<3)      ; Transmitter Enabl
                                                            e
   35 00000000 00000004 
                       USART_CR1_RE
                               EQU              (1<<2)      ; Receiver Enable
   36 00000000 00000080 
                       USART_SR_TXE
                               EQU              (1<<7)      ; Transmit Data Reg
                                                            ister Empty
   37 00000000         
   38 00000000         ;-------------------- ÂØºÂá∫ÂáΩÊï∞Á¨¶Âè∑ ---------------
                       ----------
   39 00000000                 EXPORT           USART1_Init
   40 00000000                 EXPORT           USART1_SendByte
   41 00000000                 EXPORT           USART1_SendString
   42 00000000                 EXPORT           fputc
   43 00000000         
   44 00000000         ;-------------------- ‰ª£Á†ÅÊÆµ ------------------------
                       ------
   45 00000000                 AREA             |.text|, CODE, READONLY
   46 00000000         
   47 00000000         ;-------------------------------------------------------
                       --
   48 00000000         ; ÂáΩÊï∞: USART1_Init
   49 00000000         ; ÂéüÂûã: void USART1_Init(uint32_t baudrate);
   50 00000000         ; ËæìÂÖ•: R0 (Ê≥¢ÁâπÁéá)ÔºåÂèÇÊï∞ÈÉΩÊîæÂú®R0ÁöÑ
   51 00000000         ; ÊèèËø∞: ÂàùÂßãÂåñ PB6(TX) Âíå PB7(RX)ÔºåÈÖçÁΩÆ USART1 
                       (8N1)
   52 00000000         ;-------------------------------------------------------
                       --
   53 00000000         USART1_Init
   54 00000000 B530            PUSH             {R4-R5, LR}
   55 00000002         
   56 00000002         ; 1) ‰ΩøËÉΩÊó∂Èíü
   57 00000002         ; -----------------------------------
   58 00000002         ; ÂºÄÂêØ GPIOB Êó∂Èíü



ARM Macro Assembler    Page 3 


   59 00000002 4927            LDR              R1, =RCC_AHB1ENR
   60 00000004 680A            LDR              R2, [R1]
   61 00000006 F042 0202       ORR              R2, R2, #RCC_AHB1ENR_GPIOBEN
   62 0000000A 600A            STR              R2, [R1]
   63 0000000C         
   64 0000000C         ; ÂºÄÂêØ USART1 Êó∂Èíü
   65 0000000C 4925            LDR              R1, =RCC_APB2ENR
   66 0000000E 680A            LDR              R2, [R1]
   67 00000010 F042 0210       ORR              R2, R2, #RCC_APB2ENR_USART1EN
   68 00000014 600A            STR              R2, [R1]
   69 00000016         
   70 00000016         ; 2) ÈÖçÁΩÆ GPIO (PB6, PB7)
   71 00000016         ; -----------------------------------
   72 00000016         ; MODER: ÈÖçÁΩÆ PB6, PB7 ‰∏∫Â§çÁî®Ê®°Âºè (AF = 10)
   73 00000016 4924            LDR              R1, =GPIOB_MODER
   74 00000018 680A            LDR              R2, [R1]
   75 0000001A         ; Ê∏ÖÈô§ PB6(bit13,12) Âíå PB7(bit15,14)
   76 0000001A F422 4270       BIC              R2, R2, #(0xF << 12)
   77 0000001E         ; ËÆæÁΩÆ PB6=10(binary), PB7=10(binary)
   78 0000001E F442 4220       ORR              R2, R2, #(0xA << 12)
   79 00000022 600A            STR              R2, [R1]
   80 00000024         
   81 00000024         ; OTYPER: Êé®ÊåΩËæìÂá∫ (Push-Pull = 0)
   82 00000024 4921            LDR              R1, =GPIOB_OTYPER
   83 00000026 680A            LDR              R2, [R1]
   84 00000028 F022 02C0       BIC              R2, R2, #(3 << 6) 
                                                            ; Ê∏ÖÈô§ bit 6, 7
   85 0000002C 600A            STR              R2, [R1]
   86 0000002E         
   87 0000002E         ; OSPEEDR: È´òÈÄü (High Speed = 10)
   88 0000002E 4920            LDR              R1, =GPIOB_OSPEEDR
   89 00000030 680A            LDR              R2, [R1]
   90 00000032 F422 4270       BIC              R2, R2, #(0xF << 12)
   91 00000036 F442 4220       ORR              R2, R2, #(0xA << 12)
   92 0000003A 600A            STR              R2, [R1]
   93 0000003C         
   94 0000003C         ; PUPDR: ‰∏äÊãâ (Pull-up = 01)
   95 0000003C 491D            LDR              R1, =GPIOB_PUPDR
   96 0000003E 680A            LDR              R2, [R1]
   97 00000040 F422 4270       BIC              R2, R2, #(0xF << 12)
   98 00000044 F442 42A0       ORR              R2, R2, #(0x5 << 12) 
                                                            ; 0101 binary
   99 00000048 600A            STR              R2, [R1]
  100 0000004A         
  101 0000004A         ; 3) ÈÖçÁΩÆÂ§çÁî®ÂäüËÉΩÊò†Â∞Ñ (AFRL)
  102 0000004A         ; -----------------------------------
  103 0000004A         ; PB6 -> AF7, PB7 -> AF7
  104 0000004A         ; AFRL ÊéßÂà∂ Pin 0-7, ÊØè4‰Ωç‰∏Ä‰∏™ÂºïËÑö
  105 0000004A         ; Pin 6 Âú® bit[27:24], Pin 7 Âú® bit[31:28]
  106 0000004A 491B            LDR              R1, =GPIOB_AFRL
  107 0000004C 680A            LDR              R2, [R1]
  108 0000004E F022 427F       BIC              R2, R2, #(0xFF << 24) 
                                                            ; Ê∏ÖÈô§È´ò8‰Ωç
  109 00000052 F042 62E0       ORR              R2, R2, #(GPIO_AF_USART1 << 24)
 
                                                            ; PB6 = AF7
  110 00000056 F042 42E0       ORR              R2, R2, #(GPIO_AF_USART1 << 28)
 
                                                            ; PB7 = AF7



ARM Macro Assembler    Page 4 


  111 0000005A 600A            STR              R2, [R1]
  112 0000005C         
  113 0000005C         ; 4) ÈÖçÁΩÆÊ≥¢ÁâπÁéá (BRR)
  114 0000005C         ; -----------------------------------
  115 0000005C         ; ÂÖ¨Âºè: BRR = PCLK2 / BaudRate
  116 0000005C         ; STM32F401RE‰∏≠APB2 (PCLK2) ‰∏∫ 84MHz
  117 0000005C 4917            LDR              R1, =84000000
  118 0000005E FBB1 F2F0       UDIV             R2, R1, R0  ; R2 = 84000000 / b
                                                            audrate
  119 00000062 4917            LDR              R1, =USART1_BRR
  120 00000064 600A            STR              R2, [R1]
  121 00000066         
  122 00000066         ; 5) ÈÖçÁΩÆ CR1 (‰ΩøËÉΩ UE, TE, RE)
  123 00000066         ; -----------------------------------
  124 00000066 4917            LDR              R1, =USART1_CR1
  125 00000068 F242 020C       MOV              R2, #(USART_CR1_UE | USART_CR1_
TE | USART_CR1_RE)
  126 0000006C 600A            STR              R2, [R1]
  127 0000006E         
  128 0000006E BD30            POP              {R4-R5, PC}
  129 00000070         
  130 00000070         ;-------------------------------------------------------
                       --
  131 00000070         ; ÂáΩÊï∞: USART1_SendByte
  132 00000070         ; ÂéüÂûã: void USART1_SendByte(uint8_t data);
  133 00000070         ; ËæìÂÖ•: R0 (Ë¶ÅÂèëÈÄÅÁöÑÂ≠óËäÇ)
  134 00000070         ;-------------------------------------------------------
                       --
  135 00000070         USART1_SendByte
  136 00000070 4915            LDR              R1, =USART1_SR
  137 00000072         wait_txe
  138 00000072 680A            LDR              R2, [R1]
  139 00000074 F012 0F80       TST              R2, #USART_SR_TXE ; Ê£ÄÊü• TXE 
                                                            ‰Ωç (Bit 7)
  140 00000078 D0FB            BEQ              wait_txe    ; Â¶ÇÊûú‰∏∫ 0ÔºåÁ≠â
                                                            ÂæÖ
  141 0000007A         
  142 0000007A 4914            LDR              R1, =USART1_DR
  143 0000007C 7008            STRB             R0, [R1]    ; ÂÜôÂÖ•Êï∞ÊçÆ
  144 0000007E 4770            BX               LR
  145 00000080         
  146 00000080         ;-------------------------------------------------------
                       --
  147 00000080         ; ÂáΩÊï∞: USART1_SendString
  148 00000080         ; ÂéüÂûã: void USART1_SendString(char *str);
  149 00000080         ; ËæìÂÖ•: R0 (Â≠óÁ¨¶‰∏≤È¶ñÂú∞ÂùÄ)
  150 00000080         ;-------------------------------------------------------
                       --
  151 00000080         USART1_SendString
  152 00000080 B510            PUSH             {R4, LR}    ; ‰øùÂ≠ò R4
  153 00000082 4604            MOV              R4, R0      ; Â≠óÁ¨¶‰∏≤ÊåáÈíàÂ≠
                                                            òÂÖ• R4
  154 00000084         
  155 00000084         send_str_loop
  156 00000084 7820            LDRB             R0, [R4]    ; ËØªÂèñÂ≠óÁ¨¶
  157 00000086 2800            CMP              R0, #0      ; Ê£ÄÊü•ÁªìÊùüÁ¨¶ '
                                                            \0'
  158 00000088 D004            BEQ              send_str_end
  159 0000008A         



ARM Macro Assembler    Page 5 


  160 0000008A F7FF FFFE       BL               USART1_SendByte ; ÂèëÈÄÅÂΩìÂâçÂ
                                                            ≠óÁ¨¶
  161 0000008E F104 0401       ADD              R4, R4, #1  ; ÊåáÈíà+1
  162 00000092 E7F7            B                send_str_loop
  163 00000094         
  164 00000094         send_str_end
  165 00000094 BD10            POP              {R4, PC}
  166 00000096         
  167 00000096         ;-------------------------------------------------------
                       --
  168 00000096         ; ÂáΩÊï∞: fputc (ÈáçÂÆöÂêë printf)
  169 00000096         ; ÂéüÂûã: int fputc(int ch, FILE *f);
  170 00000096         ; ËæìÂÖ•: R0 (Â≠óÁ¨¶ ch), R1 (Êñá‰ª∂ÊåáÈíà f - ÂøΩÁï•)
  171 00000096         ; ËøîÂõû: R0 (ËøîÂõûÂÜôÂÖ•ÁöÑÂ≠óÁ¨¶)
  172 00000096         ;-------------------------------------------------------
                       --
  173 00000096         fputc
  174 00000096 B500            PUSH             {LR}
  175 00000098         ; fputc ÁöÑÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞ ch Â∑≤ÁªèÂú® R0 ‰∏≠
  176 00000098         ; Áõ¥Êé•Ë∞ÉÁî® SendByte ÂèëÈÄÅ R0
  177 00000098 F7FF FFFE       BL               USART1_SendByte
  178 0000009C         
  179 0000009C         ; R0 ‰æùÁÑ∂‰øùÊåÅÂéüÊù•ÁöÑÂ≠óÁ¨¶ÂÄºÔºåÁõ¥Êé•ËøîÂõûÂç≥ÂèØ
                       Êª°Ë∂≥ fputc ÁöÑËøîÂõûÂÄºË¶ÅÊ±Ç
  180 0000009C BD00            POP              {PC}
  181 0000009E         
  182 0000009E                 END
              00 00 40023830 
              40023844 
              40020400 
              40020404 
              40020408 
              4002040C 
              40020420 
              0501BD00 
              40011008 
              4001100C 
              40011000 
              40011004 
Command Line: --debug --xref --diag_suppress=9931 --cpu=Cortex-M4.fp --apcs=int
erwork --depend=.\objects\usart1.d -o.\objects\usart1.o -I.\RTE\_f401 -ID:\keil
_v5\ARM\PACK\Keil\STM32F4xx_DFP\2.15.0\Drivers\CMSIS\Device\ST\STM32F4xx\Includ
e -ID:\keil_v5\ARM\CMSIS\Include --predefine="__MICROLIB SETA 1" --predefine="_
_UVISION_VERSION SETA 527" --predefine="STM32F401xE SETA 1" --list=.\listings\u
sart1.lst System\usart1.s



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
Relocatable symbols

.text 00000000

Symbol: .text
   Definitions
      At line 45 in file System\usart1.s
   Uses
      None
Comment: .text unused
USART1_Init 00000000

Symbol: USART1_Init
   Definitions
      At line 53 in file System\usart1.s
   Uses
      At line 39 in file System\usart1.s
Comment: USART1_Init used once
USART1_SendByte 00000070

Symbol: USART1_SendByte
   Definitions
      At line 135 in file System\usart1.s
   Uses
      At line 40 in file System\usart1.s
      At line 160 in file System\usart1.s
      At line 177 in file System\usart1.s

USART1_SendString 00000080

Symbol: USART1_SendString
   Definitions
      At line 151 in file System\usart1.s
   Uses
      At line 41 in file System\usart1.s
Comment: USART1_SendString used once
fputc 00000096

Symbol: fputc
   Definitions
      At line 173 in file System\usart1.s
   Uses
      At line 42 in file System\usart1.s
Comment: fputc used once
send_str_end 00000094

Symbol: send_str_end
   Definitions
      At line 164 in file System\usart1.s
   Uses
      At line 158 in file System\usart1.s
Comment: send_str_end used once
send_str_loop 00000084

Symbol: send_str_loop
   Definitions
      At line 155 in file System\usart1.s
   Uses
      At line 162 in file System\usart1.s
Comment: send_str_loop used once
wait_txe 00000072



ARM Macro Assembler    Page 2 Alphabetic symbol ordering
Relocatable symbols


Symbol: wait_txe
   Definitions
      At line 137 in file System\usart1.s
   Uses
      At line 140 in file System\usart1.s
Comment: wait_txe used once
8 symbols



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
Absolute symbols

GPIOB_AFRL 40020420

Symbol: GPIOB_AFRL
   Definitions
      At line 20 in file System\usart1.s
   Uses
      At line 106 in file System\usart1.s
Comment: GPIOB_AFRL used once
GPIOB_BASE 40020400

Symbol: GPIOB_BASE
   Definitions
      At line 15 in file System\usart1.s
   Uses
      At line 16 in file System\usart1.s
      At line 17 in file System\usart1.s
      At line 18 in file System\usart1.s
      At line 19 in file System\usart1.s
      At line 20 in file System\usart1.s

GPIOB_MODER 40020400

Symbol: GPIOB_MODER
   Definitions
      At line 16 in file System\usart1.s
   Uses
      At line 73 in file System\usart1.s
Comment: GPIOB_MODER used once
GPIOB_OSPEEDR 40020408

Symbol: GPIOB_OSPEEDR
   Definitions
      At line 18 in file System\usart1.s
   Uses
      At line 88 in file System\usart1.s
Comment: GPIOB_OSPEEDR used once
GPIOB_OTYPER 40020404

Symbol: GPIOB_OTYPER
   Definitions
      At line 17 in file System\usart1.s
   Uses
      At line 82 in file System\usart1.s
Comment: GPIOB_OTYPER used once
GPIOB_PUPDR 4002040C

Symbol: GPIOB_PUPDR
   Definitions
      At line 19 in file System\usart1.s
   Uses
      At line 95 in file System\usart1.s
Comment: GPIOB_PUPDR used once
GPIO_AF_USART1 00000007

Symbol: GPIO_AF_USART1
   Definitions
      At line 32 in file System\usart1.s
   Uses
      At line 109 in file System\usart1.s



ARM Macro Assembler    Page 2 Alphabetic symbol ordering
Absolute symbols

      At line 110 in file System\usart1.s

RCC_AHB1ENR 40023830

Symbol: RCC_AHB1ENR
   Definitions
      At line 11 in file System\usart1.s
   Uses
      At line 59 in file System\usart1.s
Comment: RCC_AHB1ENR used once
RCC_AHB1ENR_GPIOBEN 00000002

Symbol: RCC_AHB1ENR_GPIOBEN
   Definitions
      At line 30 in file System\usart1.s
   Uses
      At line 61 in file System\usart1.s
Comment: RCC_AHB1ENR_GPIOBEN used once
RCC_APB2ENR 40023844

Symbol: RCC_APB2ENR
   Definitions
      At line 12 in file System\usart1.s
   Uses
      At line 65 in file System\usart1.s
Comment: RCC_APB2ENR used once
RCC_APB2ENR_USART1EN 00000010

Symbol: RCC_APB2ENR_USART1EN
   Definitions
      At line 31 in file System\usart1.s
   Uses
      At line 67 in file System\usart1.s
Comment: RCC_APB2ENR_USART1EN used once
RCC_BASE 40023800

Symbol: RCC_BASE
   Definitions
      At line 10 in file System\usart1.s
   Uses
      At line 11 in file System\usart1.s
      At line 12 in file System\usart1.s

USART1_BASE 40011000

Symbol: USART1_BASE
   Definitions
      At line 23 in file System\usart1.s
   Uses
      At line 24 in file System\usart1.s
      At line 25 in file System\usart1.s
      At line 26 in file System\usart1.s
      At line 27 in file System\usart1.s

USART1_BRR 40011008

Symbol: USART1_BRR
   Definitions
      At line 26 in file System\usart1.s



ARM Macro Assembler    Page 3 Alphabetic symbol ordering
Absolute symbols

   Uses
      At line 119 in file System\usart1.s
Comment: USART1_BRR used once
USART1_CR1 4001100C

Symbol: USART1_CR1
   Definitions
      At line 27 in file System\usart1.s
   Uses
      At line 124 in file System\usart1.s
Comment: USART1_CR1 used once
USART1_DR 40011004

Symbol: USART1_DR
   Definitions
      At line 25 in file System\usart1.s
   Uses
      At line 142 in file System\usart1.s
Comment: USART1_DR used once
USART1_SR 40011000

Symbol: USART1_SR
   Definitions
      At line 24 in file System\usart1.s
   Uses
      At line 136 in file System\usart1.s
Comment: USART1_SR used once
USART_CR1_RE 00000004

Symbol: USART_CR1_RE
   Definitions
      At line 35 in file System\usart1.s
   Uses
      At line 125 in file System\usart1.s
Comment: USART_CR1_RE used once
USART_CR1_TE 00000008

Symbol: USART_CR1_TE
   Definitions
      At line 34 in file System\usart1.s
   Uses
      At line 125 in file System\usart1.s
Comment: USART_CR1_TE used once
USART_CR1_UE 00002000

Symbol: USART_CR1_UE
   Definitions
      At line 33 in file System\usart1.s
   Uses
      At line 125 in file System\usart1.s
Comment: USART_CR1_UE used once
USART_SR_TXE 00000080

Symbol: USART_SR_TXE
   Definitions
      At line 36 in file System\usart1.s
   Uses
      At line 139 in file System\usart1.s
Comment: USART_SR_TXE used once



ARM Macro Assembler    Page 4 Alphabetic symbol ordering
Absolute symbols

21 symbols
365 symbols in table
